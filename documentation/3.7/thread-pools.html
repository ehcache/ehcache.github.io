<div class="sect1">
<h2 id="introduction"><a class="anchor" href="#introduction"></a>Introduction to Thread Pools</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Some services work asynchronously, hence they require thread pools to perform their tasks.
All thread pooling facilities are centralized behind the <code>ExecutionService</code> interface.</p>
</div>
<div class="paragraph">
<p>Let&#8217;s start with a bit of theory.</p>
</div>
<div class="sect2">
<h3 id="what-executionservice-provides"><a class="anchor" href="#what-executionservice-provides"></a>What <code>ExecutionService</code> provides</h3>
<div class="paragraph">
<p><code>ExecutionService</code> is an interface providing:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>ScheduledExecutorService</code> to schedule tasks, i.e.: tasks that happen repeatedly after a configurable delay.</p>
</li>
<li>
<p>Unordered <code>ExecutorService</code> to execute tasks as soon as a thread is available.</p>
</li>
<li>
<p>Ordered <code>ExecutorService</code> to execute tasks as soon as a thread is available, with the guarantee that tasks are going to be executed in the order they were submitted.</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="available-executionservice-implementations"><a class="anchor" href="#available-executionservice-implementations"></a>Available <code>ExecutionService</code> implementations</h3>
<div class="paragraph">
<p>There currently are two bundled implementations:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>OnDemandExecutionService</code> creates a new pool each time an executor service (scheduled or not) is requested.
This implementation is the default one and requires no configuration at all.</p>
</li>
<li>
<p><code>PooledExecutionService</code> keeps a configurable set of thread pools and divides them to handle all executor service requests.
This implementation must be configured with a <code>PooledExecutionServiceConfiguration</code> when used.</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="configuring-pooledexecutionservice"><a class="anchor" href="#configuring-pooledexecutionservice"></a>Configuring <code>PooledExecutionService</code></h3>
<div class="paragraph">
<p>When you want total control of the threads used by a cache manager and its caches, you have to use a <code>PooledExecutionService</code>
that itself must be configured as it does not have any defaults.</p>
</div>
<div class="paragraph">
<p>The <code>PooledExecutionServiceConfigurationBuilder</code> can be used for this purpose, and the resulting configuration it builds can simply be added
to a <code>CacheManagerBuilder</code> to switch the <code>ExecutionService</code> implementation to a <code>PooledExecutionService</code>.</p>
</div>
<div class="paragraph">
<p>The builder has two interesting methods:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>defaultPool</code> that is used to set the default pool. There can be only one default pool, its name does not matter,
and if thread-using services do not specify a thread pool, this is the one that will be used.</p>
</li>
<li>
<p><code>pool</code> that is used to add a thread pool.
There can be as many pools as you wish but services must explicitly be configured to make use of them.</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="using-the-configured-thread-pools"><a class="anchor" href="#using-the-configured-thread-pools"></a>Using the configured thread pools</h3>
<div class="paragraph">
<p>Following is the list of services making use of <code>ExecutionService</code>:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Disk store: disk writes are performed asynchronously.</p>
<div class="paragraph">
<p><code>OffHeapDiskStoreConfiguration</code> is used to configure what thread pool to use at the cache level,
while <code>OffHeapDiskStoreProviderConfiguration</code> is used to configure what thread pool to use at the cache manager level.</p>
</div>
</li>
<li>
<p>Write Behind: CacheLoaderWriter write tasks happen asynchronously.</p>
<div class="paragraph">
<p><code>DefaultWriteBehindConfiguration</code> is used to configure what thread pool to use at the cache level,
while <code>WriteBehindProviderConfiguration</code> is used to configure what thread pool to use at the cache manager level.</p>
</div>
</li>
<li>
<p>Eventing: produced events are queued and sent to the listeners by a thread pool.</p>
<div class="paragraph">
<p><code>DefaultCacheEventDispatcherConfiguration</code> is used to configure what thread pool to use at the cache level,
while <code>CacheEventDispatcherFactoryConfiguration</code> is used to configure what thread pool to use at the cache manager level.</p>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>The different builders will make use of the right configuration class, you do not have to use those classes directly.
For instance, calling <code>CacheManagerBuilder.withDefaultDiskStoreThreadPool(String threadPoolAlias)</code> actually is identical
to calling <code>CacheManagerBuilder.using(new OffHeapDiskStoreProviderConfiguration(threadPoolAlias))</code>.</p>
</div>
<div class="paragraph">
<p>The thread pool to use can be configured on a service through the builders by using the methods carrying a <code>ThreadPool</code> related name.
When a service is not told anything about which thread pool to use, the default thread pool is used.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="using-code"><a class="anchor" href="#using-code"></a>Configuring Thread Pools with Code</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Following are examples of describing how to configure the thread pools the different services will use.</p>
</div>
<div class="sect2">
<h3 id="disk-store"><a class="anchor" href="#disk-store"></a>Disk store</h3>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight nowrap"><code class="language-java" data-lang="java">    CacheManager cacheManager
        = CacheManagerBuilder.newCacheManagerBuilder()
        .using(PooledExecutionServiceConfigurationBuilder.newPooledExecutionServiceConfigurationBuilder() <i class="conum" data-value="1"></i><b>(1)</b>
            .defaultPool("dflt", 0, 10)
            .pool("defaultDiskPool", 1, 3)
            .pool("cache2Pool", 2, 2)
            .build())
        .with(new CacheManagerPersistenceConfiguration(new File(getStoragePath(), "myData")))
        .withDefaultDiskStoreThreadPool("defaultDiskPool") <i class="conum" data-value="2"></i><b>(2)</b>
        .withCache("cache1",
            CacheConfigurationBuilder.newCacheConfigurationBuilder(Long.class, String.class,
                ResourcePoolsBuilder.newResourcePoolsBuilder()
                    .heap(10, EntryUnit.ENTRIES)
                    .disk(10L, MemoryUnit.MB)))
        .withCache("cache2",
            CacheConfigurationBuilder.newCacheConfigurationBuilder(Long.class, String.class,
                ResourcePoolsBuilder.newResourcePoolsBuilder()
                    .heap(10, EntryUnit.ENTRIES)
                    .disk(10L, MemoryUnit.MB))
                .withDiskStoreThreadPool("cache2Pool", 2)) <i class="conum" data-value="3"></i><b>(3)</b>
        .build(true);

    Cache&lt;Long, String&gt; cache1 =
        cacheManager.getCache("cache1", Long.class, String.class);
    Cache&lt;Long, String&gt; cache2 =
        cacheManager.getCache("cache2", Long.class, String.class);

    cacheManager.close();</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Configure the thread pools. Note that the default one (<code>dflt</code>) is required for the events even when no event listener is configured.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Tell the <code>CacheManagerBuilder</code> to use a default thread pool for all disk stores that don&#8217;t explicitly specify one.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Tell the cache to use a specific thread pool for its disk store.</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="write-behind"><a class="anchor" href="#write-behind"></a>Write Behind</h3>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight nowrap"><code class="language-java" data-lang="java">    CacheManager cacheManager
        = CacheManagerBuilder.newCacheManagerBuilder()
        .using(PooledExecutionServiceConfigurationBuilder.newPooledExecutionServiceConfigurationBuilder() <i class="conum" data-value="1"></i><b>(1)</b>
            .defaultPool("dflt", 0, 10)
            .pool("defaultWriteBehindPool", 1, 3)
            .pool("cache2Pool", 2, 2)
            .build())
        .withDefaultWriteBehindThreadPool("defaultWriteBehindPool") <i class="conum" data-value="2"></i><b>(2)</b>
        .withCache("cache1",
            CacheConfigurationBuilder.newCacheConfigurationBuilder(Long.class, String.class,
                                          ResourcePoolsBuilder.newResourcePoolsBuilder().heap(10, EntryUnit.ENTRIES))
                .withLoaderWriter(new SampleLoaderWriter&lt;&gt;(singletonMap(41L, "zero")))
                .add(WriteBehindConfigurationBuilder
                    .newBatchedWriteBehindConfiguration(1, TimeUnit.SECONDS, 3)
                    .queueSize(3)
                    .concurrencyLevel(1)))
        .withCache("cache2",
            CacheConfigurationBuilder.newCacheConfigurationBuilder(Long.class, String.class,
                                          ResourcePoolsBuilder.newResourcePoolsBuilder().heap(10, EntryUnit.ENTRIES))
                .withLoaderWriter(new SampleLoaderWriter&lt;&gt;(singletonMap(41L, "zero")))
                .add(WriteBehindConfigurationBuilder
                    .newBatchedWriteBehindConfiguration(1, TimeUnit.SECONDS, 3)
                    .useThreadPool("cache2Pool") <i class="conum" data-value="3"></i><b>(3)</b>
                    .queueSize(3)
                    .concurrencyLevel(2)))
        .build(true);

    Cache&lt;Long, String&gt; cache1 =
        cacheManager.getCache("cache1", Long.class, String.class);
    Cache&lt;Long, String&gt; cache2 =
        cacheManager.getCache("cache2", Long.class, String.class);

    cacheManager.close();</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Configure the thread pools. Note that the default one (<code>dflt</code>) is required for the events even when no event listener is configured.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Tell the <code>CacheManagerBuilder</code> to use a default thread pool for all write-behind caches that don&#8217;t explicitly specify one.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Tell the <code>WriteBehindConfigurationBuilder</code> to use a specific thread pool for its write-behind work.</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="events"><a class="anchor" href="#events"></a>Events</h3>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight nowrap"><code class="language-java" data-lang="java">    CacheManager cacheManager
        = CacheManagerBuilder.newCacheManagerBuilder()
        .using(PooledExecutionServiceConfigurationBuilder.newPooledExecutionServiceConfigurationBuilder() <i class="conum" data-value="1"></i><b>(1)</b>
            .pool("defaultEventPool", 1, 3)
            .pool("cache2Pool", 2, 2)
            .build())
        .withDefaultEventListenersThreadPool("defaultEventPool") <i class="conum" data-value="2"></i><b>(2)</b>
        .withCache("cache1",
            CacheConfigurationBuilder.newCacheConfigurationBuilder(Long.class, String.class,
                                          ResourcePoolsBuilder.newResourcePoolsBuilder().heap(10, EntryUnit.ENTRIES))
                .add(CacheEventListenerConfigurationBuilder
                    .newEventListenerConfiguration(new ListenerObject(), EventType.CREATED, EventType.UPDATED)))
        .withCache("cache2",
            CacheConfigurationBuilder.newCacheConfigurationBuilder(Long.class, String.class,
                                          ResourcePoolsBuilder.newResourcePoolsBuilder().heap(10, EntryUnit.ENTRIES))
                .add(CacheEventListenerConfigurationBuilder
                    .newEventListenerConfiguration(new ListenerObject(), EventType.CREATED, EventType.UPDATED))
                .withEventListenersThreadPool("cache2Pool")) <i class="conum" data-value="3"></i><b>(3)</b>
        .build(true);

    Cache&lt;Long, String&gt; cache1 =
        cacheManager.getCache("cache1", Long.class, String.class);
    Cache&lt;Long, String&gt; cache2 =
        cacheManager.getCache("cache2", Long.class, String.class);

    cacheManager.close();</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Configure the thread pools. Note that there is no default one so all thread-using services must be configured with explicit defaults.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Tell the <code>CacheManagerBuilder</code> to use a default thread pool to manage events of all caches that don&#8217;t explicitly specify one.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Tell the <code>CacheEventListenerConfigurationBuilder</code> to use a specific thread pool for sending its events.</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="using-xml"><a class="anchor" href="#using-xml"></a>Configuring Thread Pools with XML</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Following is an example describing how to configure the thread pools the different services will use:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight nowrap"><code class="language-xml" data-lang="xml">  &lt;thread-pools&gt; <i class="conum" data-value="1"></i><b>(1)</b>
    &lt;thread-pool alias="defaultDiskPool" min-size="1" max-size="3"/&gt;
    &lt;thread-pool alias="defaultWriteBehindPool" min-size="1" max-size="3"/&gt;
    &lt;thread-pool alias="cache2Pool" min-size="2" max-size="2"/&gt;
  &lt;/thread-pools&gt;

  &lt;event-dispatch thread-pool="defaultEventPool"/&gt; <i class="conum" data-value="2"></i><b>(2)</b>
  &lt;write-behind thread-pool="defaultWriteBehindPool"/&gt; <i class="conum" data-value="3"></i><b>(3)</b>
  &lt;disk-store thread-pool="defaultDiskPool"/&gt; <i class="conum" data-value="4"></i><b>(4)</b>

  &lt;cache alias="cache1"&gt;
    &lt;key-type&gt;java.lang.Long&lt;/key-type&gt;
    &lt;value-type&gt;java.lang.String&lt;/value-type&gt;

    &lt;resources&gt;
      &lt;heap unit="entries"&gt;10&lt;/heap&gt;
      &lt;disk unit="MB"&gt;10&lt;/disk&gt;
    &lt;/resources&gt;
  &lt;/cache&gt;

  &lt;cache alias="cache2"&gt;
    &lt;key-type&gt;java.lang.Long&lt;/key-type&gt;
    &lt;value-type&gt;java.lang.String&lt;/value-type&gt;

    &lt;loader-writer&gt;
      &lt;class&gt;org.ehcache.docs.plugs.ListenerObject&lt;/class&gt;
      &lt;write-behind thread-pool="cache2Pool"&gt; <i class="conum" data-value="5"></i><b>(5)</b>
        &lt;batching batch-size="5"&gt;
          &lt;max-write-delay unit="seconds"&gt;10&lt;/max-write-delay&gt;
        &lt;/batching&gt;
      &lt;/write-behind&gt;
    &lt;/loader-writer&gt;
    &lt;listeners dispatcher-thread-pool="cache2Pool"/&gt; <i class="conum" data-value="6"></i><b>(6)</b>
    &lt;resources&gt;
      &lt;heap unit="entries"&gt;10&lt;/heap&gt;
      &lt;disk unit="MB"&gt;10&lt;/disk&gt;
    &lt;/resources&gt;
    &lt;disk-store-settings thread-pool="cache2Pool" writer-concurrency="2"/&gt; <i class="conum" data-value="7"></i><b>(7)</b>
  &lt;/cache&gt;</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Configure the thread pools. Note that there is no default one.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Configure the default thread pool this cache manager will use to send events.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Configure the default thread pool this cache manager will use for write-behind work.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Configure the default thread pool this cache manager will use for disk stores.</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>Configure a specific write-behind thread pool for this cache.</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td>Configure a specific thread pool for this cache to send its events.</td>
</tr>
<tr>
<td><i class="conum" data-value="7"></i><b>7</b></td>
<td>Configure a specific thread pool for this cache&#8217;s disk store.</td>
</tr>
</table>
</div>
</div>
</div>