<div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>This guide provides sample code snippets to help migrate Ehcache 2.x code to Ehcache 3.x code.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="per-mapping-expiry"><a class="anchor" href="#per-mapping-expiry"></a>Per Mapping Expiry</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Per mapping expiry covers use cases where a subset of mappings have different expiration settings than the ones configured at the cache level.</p>
</div>
<div class="sect2">
<h3 id="ehcache-2-x-code"><a class="anchor" href="#ehcache-2-x-code"></a>Ehcache 2.x Code</h3>
<div class="paragraph">
<p>Here we are creating a cache manager that has a default time-to-live (TTL) expiry.</p>
</div>
<div class="paragraph">
<p>Before adding, we verify the expiry and set it on the <code>Element</code> only when different than the <code>Cache</code> expiry.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">int defaultCacheTTLInSeconds = 20;

CacheManager cacheManager = initCacheManager();
CacheConfiguration cacheConfiguration = new CacheConfiguration().name("cache")
    .maxEntriesLocalHeap(100)
    .timeToLiveSeconds(defaultCacheTTLInSeconds);   <i class="conum" data-value="1"></i><b>(1)</b>
cacheManager.addCache(new Cache(cacheConfiguration));

Element element = new Element(10L, "Hello");

int ttlInSeconds = getTimeToLiveInSeconds((Long)element.getObjectKey(), (String)element.getObjectValue()); <i class="conum" data-value="2"></i><b>(2)</b>

if (ttlInSeconds != defaultCacheTTLInSeconds) {   <i class="conum" data-value="3"></i><b>(3)</b>
  element.setTimeToLive(ttlInSeconds);
}

cacheManager.getCache("cache").put(element);

System.out.println(cacheManager.getCache("cache").get(10L).getObjectValue());

sleep(2100);  <i class="conum" data-value="4"></i><b>(4)</b>

// Now the returned element should be null, as the mapping is expired.
System.out.println(cacheManager.getCache("cache").get(10L));</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Expiry duration defined at the cache level.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Compute the mapping expiry using the helper method <code>getTimeToLiveInSeconds</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Only setting the computed expiry on element if other than default expiry.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Waiting for 2.1 seconds - assuming 2 seconds is the custom expiry duration - to get the mapping to be expired.</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="corresponding-ehcache-3-x-code"><a class="anchor" href="#corresponding-ehcache-3-x-code"></a>Corresponding Ehcache 3.x Code</h3>
<div class="paragraph">
<p>Here we are creating a cache manager with a cache configuration specifying a custom expiry,
having dedicated logic in the methods called during the lifecycle of added and updated mappings.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight nowrap"><code class="language-java" data-lang="java">CacheManager cacheManager = initCacheManager();
CacheConfigurationBuilder&lt;Long, String&gt; configuration =
    CacheConfigurationBuilder.newCacheConfigurationBuilder(Long.class, String.class, ResourcePoolsBuilder
        .heap(100))
        .withExpiry(new ExpiryPolicy&lt;Long, String&gt;() {    <i class="conum" data-value="1"></i><b>(1)</b>
          @Override
          public Duration getExpiryForCreation(Long key, String value) {
            return getTimeToLiveDuration(key, value);   <i class="conum" data-value="2"></i><b>(2)</b>
          }

          @Override
          public Duration getExpiryForAccess(Long key, Supplier&lt;? extends String&gt; value) {
            return null;  // Keeping the existing expiry
          }

          @Override
          public Duration getExpiryForUpdate(Long key, Supplier&lt;? extends String&gt; oldValue, String newValue) {
            return null;  // Keeping the existing expiry
          }
        });
cacheManager.createCache("cache", configuration);

Cache&lt;Long, String&gt; cache = cacheManager.getCache("cache", Long.class, String.class);
cache.put(10L, "Hello");

System.out.println(cache.get(10L));

sleep(2100);  <i class="conum" data-value="3"></i><b>(3)</b>

// Now the returned value should be null, as mapping is expired.
System.out.println(cache.get(10L));</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Defining custom expiry to be called during the lifecycle of added mappings.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>During mapping creation, defining expiry duration using the helper method <code>getTimeToLiveDuration</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Waiting for 2.1 seconds - assuming 2 seconds is the custom expiry duration - to get the mapping to be expired.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>So to migrate the former Ehcache per mapping expiry code to the current version of Ehcache,
move the expiry computation logic to the <code>getExpiryForCreation</code> method of the created custom expiry.</p>
</div>
</div>
</div>
</div>