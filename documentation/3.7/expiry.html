<div class="sect1">
<h2 id="introduction"><a class="anchor" href="#introduction"></a>Introduction</h2>
<div class="sectionbody">
<div class="paragraph">
<p>As conveyed in the <a href="caching-concepts.html#data-freshness-and-expiration"><em>Data Freshness and Expiration</em></a> documentation, this is one of the key aspects of caching.
In Ehcache 3 this is addressed with the <code>ExpiryPolicy</code> interface and its use in controlling the age of cache mappings.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="configuration"><a class="anchor" href="#configuration"></a>Configuration</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Expiry is configured at the cache level, in Java or in XML:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">CacheConfiguration&lt;Long, String&gt; cacheConfiguration = CacheConfigurationBuilder.newCacheConfigurationBuilder(Long.class, String.class,
        ResourcePoolsBuilder.heap(100)) <i class="conum" data-value="1"></i><b>(1)</b>
    .withExpiry(ExpiryPolicyBuilder.timeToLiveExpiration(Duration.ofSeconds(20))) <i class="conum" data-value="2"></i><b>(2)</b>
    .build();</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Expiry policy is configured at the cache level, so start by defining a cache configuration,</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>then add to it an <code>ExpiryPolicy</code>, here using the predefined <em>time-to-live</em> one, configured with the required <code>Duration</code>.</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-xml" data-lang="xml">&lt;cache alias="withExpiry"&gt;
  &lt;expiry&gt;
    &lt;ttl unit="seconds"&gt;20&lt;/ttl&gt; <i class="conum" data-value="1"></i><b>(1)</b>
  &lt;/expiry&gt;
  &lt;heap&gt;100&lt;/heap&gt;
&lt;/cache&gt;</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>At the cache level, using the predefined <em>time-to-live</em> again.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Both Java and XML offer direct support for three types of expiry:</p>
</div>
<div class="hdlist">
<table>
<tr>
<td class="hdlist1">
no expiry
</td>
<td class="hdlist2">
<p>this means cache mappings will never expire,</p>
</td>
</tr>
<tr>
<td class="hdlist1">
time-to-live
</td>
<td class="hdlist2">
<p>this means cache mappings will expire after a fixed duration following their creation,</p>
</td>
</tr>
<tr>
<td class="hdlist1">
time-to-idle
</td>
<td class="hdlist2">
<p>this means cache mappings will expire after a fixed duration following the time they were last accessed.</p>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>For Java, see <code>org.ehcache.config.builders.ExpiryPolicyBuilder</code> and the XSD for XML.</p>
</div>
<div class="paragraph">
<p>Read on to implement your own expiration scheme.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="custom-expiry"><a class="anchor" href="#custom-expiry"></a>Custom expiry</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Supporting your own expiration scheme simply means implementing the <code>ExpiryPolicy</code> interface:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">/**
 * A policy object that governs expiration for mappings in a {@link org.ehcache.Cache Cache}.
 * &lt;p&gt;
 * Previous values are not accessible directly but are rather available through a value {@code Supplier}
 * to indicate that access can require computation (such as deserialization).
 * &lt;p&gt;
 * {@link java.time.Duration#isNegative() Negative durations} are not supported, expiry policy implementation returning such a
 * duration will result in immediate expiry, as if the duration was {@link java.time.Duration#ZERO zero}.
 * &lt;p&gt;
 * NOTE: Some cache configurations (eg. caches with eventual consistency) may use local (ie. non-consistent) state
 * to decide whether to call {@link #getExpiryForUpdate(Object, Supplier, Object)}  vs.
 * {@link #getExpiryForCreation(Object, Object)}. For these cache configurations it is advised to return the same
 * value for both of these methods
 *
 * @param &lt;K&gt; the key type for the cache
 * @param &lt;V&gt; the value type for the cache
 *
 */
public interface ExpiryPolicy&lt;K, V&gt; {

  /**
   * A {@link Duration duration} that represents an infinite time.
   */
  Duration INFINITE = Duration.ofNanos(Long.MAX_VALUE);

  /**
   * An {@code ExpiryPolicy} that represents a no expiration policy
   */
  ExpiryPolicy&lt;Object, Object&gt; NO_EXPIRY = new ExpiryPolicy&lt;Object, Object&gt;() {
    @Override
    public Duration getExpiryForCreation(Object key, Object value) {
      return INFINITE;
    }

    @Override
    public Duration getExpiryForAccess(Object key, Supplier&lt;?&gt; value) {
      return null;
    }

    @Override
    public Duration getExpiryForUpdate(Object key, Supplier&lt;?&gt; oldValue, Object newValue) {
      return null;
    }
  };

  /**
   * Returns the lifetime of an entry when it is initially added to a {@link org.ehcache.Cache Cache}.
   * &lt;p&gt;
   * This method must not return {@code null}.
   * &lt;p&gt;
   * Exceptions thrown from this method will be swallowed and result in the expiry duration being
   * {@link Duration#ZERO ZERO}.
   *
   * @param key the key of the newly added entry
   * @param value the value of the newly added entry
   * @return a non-null {@code Duration}
   */
  Duration getExpiryForCreation(K key, V value);

  /**
   * Returns the expiration {@link Duration duration} (relative to the current time) when an existing entry
   * is accessed from a {@link org.ehcache.Cache Cache}.
   * &lt;p&gt;
   * Returning {@code null} indicates that the expiration time remains unchanged.
   * &lt;p&gt;
   * Exceptions thrown from this method will be swallowed and result in the expiry duration being
   * {@link Duration#ZERO ZERO}.
   *
   * @param key the key of the accessed entry
   * @param value a value supplier for the accessed entry
   * @return an expiration {@code Duration}, {@code null} means unchanged
   */
  Duration getExpiryForAccess(K key, Supplier&lt;? extends V&gt; value);


  /**
   * Returns the expiration {@link Duration duration} (relative to the current time) when an existing entry
   * is updated in a {@link org.ehcache.Cache Cache}.
   * &lt;p&gt;
   * Returning {@code null} indicates that the expiration time remains unchanged.
   * &lt;p&gt;
   * Exceptions thrown from this method will be swallowed and result in the expiry duration being
   * {@link Duration#ZERO ZERO}.
   *
   * @param key the key of the updated entry
   * @param oldValue a value supplier for the previous value of the entry
   * @param newValue the new value of the entry
   * @return an expiration {@code Duration}, {@code null} means unchanged
   */
  Duration getExpiryForUpdate(K key, Supplier&lt;? extends V&gt; oldValue, V newValue);

}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The main points to remember on the return value from these methods:</p>
</div>
<div class="hdlist">
<table>
<tr>
<td class="hdlist1">
some <code>Duration</code>
</td>
<td class="hdlist2">
<p>indicates that the mapping will expire after that duration,</p>
</td>
</tr>
<tr>
<td class="hdlist1">
<code>Duration.ZERO</code>
</td>
<td class="hdlist2">
<p>indicates that the mapping is immediately expired,</p>
</td>
</tr>
<tr>
<td class="hdlist1">
<code>Duration.INFINITE</code>
</td>
<td class="hdlist2">
<p>indicates that the mapping will never expire,</p>
</td>
</tr>
<tr>
<td class="hdlist1">
<code>null</code> <code>Duration</code>
</td>
<td class="hdlist2">
<p>indicates that the previous expiration time is to be left unchanged, illegal at mapping creation time.</p>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Note that you can access the details of the mapping, thus providing expiration times that are different per mapping.</p>
</div>
<div class="paragraph">
<p>Also when used from XML, Ehcache expects your expiry implementation to have a <em>no-arg</em> constructor.</p>
</div>
<div class="paragraph">
<p>Once you have implemented your own expiry policy, simply configure it.</p>
</div>
<div class="paragraph">
<p>In Java:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">CacheConfiguration&lt;Long, String&gt; cacheConfiguration = CacheConfigurationBuilder.newCacheConfigurationBuilder(Long.class, String.class,
        ResourcePoolsBuilder.heap(100))
    .withExpiry(new CustomExpiry()) <i class="conum" data-value="1"></i><b>(1)</b>
    .build();</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Simply pass your custom expiry instance into the cache builder.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>In XML:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-xml" data-lang="xml">&lt;cache alias="withCustomExpiry"&gt;
  &lt;expiry&gt;
    &lt;class&gt;com.pany.ehcache.MyExpiry&lt;/class&gt; <i class="conum" data-value="1"></i><b>(1)</b>
  &lt;/expiry&gt;
  &lt;heap&gt;100&lt;/heap&gt;
&lt;/cache&gt;</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Simply pass the fully qualified class name of your custom expiry.</td>
</tr>
</table>
</div>
<div class="sidebarblock">
<div class="content">
<div class="paragraph">
<p>There is a <a href="migration-guide.html#per-mapping-expiry"><em>migration guide</em></a> in place to demonstrate how to migrate the Ehcache 2.x per mapping expiry code to Ehcache 3.x.</p>
</div>
</div>
</div>
</div>
</div>